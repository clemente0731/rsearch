name: package-extension

on:
  workflow_dispatch:
  release:
    types:
      - published

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: run packaging
        run: npm run package

      - name: capture package metadata
        id: package_meta
        run: |
          PACKAGE_VERSION=$(node --input-type=module -e "import { readFileSync } from 'fs'; const data = JSON.parse(readFileSync('dist/package-info.json', 'utf8')); if (!data.version) { process.exit(1); } console.log(data.version);")
          ARTIFACT_NAME=$(node --input-type=module -e "import { readFileSync } from 'fs'; const data = JSON.parse(readFileSync('dist/package-info.json', 'utf8')); if (!data.artifact) { process.exit(1); } console.log(data.artifact);")
          echo "package_version=${PACKAGE_VERSION}" >> "$GITHUB_OUTPUT"
          echo "artifact_name=${ARTIFACT_NAME}" >> "$GITHUB_OUTPUT"
          echo "PACKAGE_VERSION=${PACKAGE_VERSION}" >> "$GITHUB_ENV"
          echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> "$GITHUB_ENV"

      - name: upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension-${{ steps.package_meta.outputs.package_version }}
          path: dist/${{ steps.package_meta.outputs.artifact_name }}

      - name: upload release asset
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/${{ steps.package_meta.outputs.artifact_name }}

      - name: publish to github packages
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PACKAGE_NAME: rsearch-extension
          PACKAGE_VERSION: ${{ steps.package_meta.outputs.package_version }}
          ARTIFACT_NAME: ${{ steps.package_meta.outputs.artifact_name }}
        run: |
          gh api \
            --method PUT \
            -H "Content-Type: application/zip" \
            --input dist/${ARTIFACT_NAME} \
            /repos/${{ github.repository }}/packages/generic/${PACKAGE_NAME}/${PACKAGE_VERSION}/${ARTIFACT_NAME}
